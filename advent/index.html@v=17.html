<!DOCTYPE html>
<html lang="hu" class="no-js">

<head>
<meta charset="utf-8">
<title>InfoC :: Adventi naptár</title>
<meta property="og:title" content="InfoC :: Adventi naptár">
<meta property="og:image" content="/modulz/logo.png">
<meta property="og:description" content="InfoC :: Adventi naptár">
<meta property="og:site_name" content="InfoC – Programozás alapjai I.">
<meta name="description" content="InfoC :: Adventi naptár">
<meta name="keywords" content="bme eet infoc programozás prog1 szoftlab1">
<meta name="robots" content="noarchive">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="../modulz/favicon.ico" id="faviconhref">
<link rel="apple-touch-icon" href="../modulz/logo_touch.png">
<link rel="image_src" href="../modulz/logo.png"> 
<script>var infoc = { onloads: [], onresize: [] };</script>
<link rel="stylesheet" href="../modulz/style/style-vik.css@v10.css">
<link rel="stylesheet" href="../modulz/style/localfonts.css@v10.css">
<script src="../modulz/siteui.js@v10" async></script>
</head>

<body class="doksibody">
<!--[if lt IE 9]>
<blockquote><p>A régi Internet Explorer böngésző, amit használsz, nem támogatott!
Az oldal használatához keress egy <a href="http://browsehappy.com/">jobb, újabb böngészőprogramot</a>!</p></blockquote>
<![endif]-->
<div id="bodycontent">

<nav role="navigation">
<div id="menubg">
<div id="menu" class="shaper dropdown">
<div class="infoc"><a href="../index.html">InfoC</a></div>
<ul>
<li class="al "><a href="index.html@v=17.html#" onclick="menu_click(this)">Infó</a>
<ul>
<li><a href="../index.html">Kezdőlap</a>
<li><a href="../nhf.html">Nagy házi feladat</a>
<li><a href="../elerhetoseg.html">Elérhetőség</a>
</ul>

<li class="al "><a href="index.html@v=17.html#" onclick="menu_click(this)">Tananyag</a>
<ul>
<li class="al "><a href="index.html@v=17.html#" onclick="menu_click(this)">Előadás</a>
<ul>
<li><a href="../ea01.html">1. hét: bevezetés</a>
<li><a href="../ea02.html">2. hét: algoritmusok</a>
<li><a href="../ea03.html">3. hét: tételek, tömbök</a>
<li><a href="../ea04.html">4. hét: függvények, számábrázolás</a>
<li><a href="../ea05.html">5. hét: operátorok, struktúrák</a>
<li><a href="../ea06.html">6. hét: pointerek, állapotgépek</a>
<li><a href="../ea07.html">7. hét: rendezések, rekurzió</a>
<li><a href="../ea08.html">8. hét: dinamikus memóriakezelés</a>
<li><a href="../ea09.html">9. hét: láncolt listák</a>
<li><a href="../ea11.html">11. hét: fájlkezelés, modulok</a>
<li><a href="../ea12.html">12. hét: bináris fák</a>
<li><a href="../ea13.html">13. hét: generikus algoritmusok</a>
<li><a href="../ea14.html">14. hét: nagy program tervezése</a>
</ul>

<li class="al "><a href="index.html@v=17.html#" onclick="menu_click(this)">Gyakorlat</a>
<ul>
<li><a href="../gy01.html">1. hét: tanult algoritmusok</a>
<li><a href="../gy02.html">2. hét: algoritmizálás</a>
<li><a href="../gy03.html">3. hét: egyszerű programok</a>
<li><a href="../gy04.html">4. hét: tételek és tömbök</a>
<li><a href="../gy05.html">5. hét: függvények</a>
<li><a href="../gy06.html">6. hét: származtatott típusok</a>
<li><a href="../gy07.html">7. hét: mutatók használata</a>
<li><a href="../gy08.html">8. hét: rekurzió, állapotgép</a>
<li><a href="../gy09.html">9. hét: dinamikus tömbök</a>
<li><a href="../gy11.html">11. hét: láncolt listák I.</a>
<li><a href="../gy12.html">12. hét: láncolt listák II.</a>
<li><a href="../gy13.html">13. hét: bináris fák</a>
<li><a href="../gy14.html">14. hét: generikus algoritmusok</a>
</ul>

<li class="al "><a href="index.html@v=17.html#" onclick="menu_click(this)">Labor</a>
<ul>
<li><a href="../lab01.html">1. hét: operációs rendszer</a>
<li><a href="../lab02.html">2. hét: fejlesztőkörnyezet használata</a>
<li><a href="../lab03.html">3. hét: egyszerű programok</a>
<li><a href="../lab04.html">4. hét: tömbök</a>
<li><a href="../lab06.html">6. hét: struktúrák és függvények</a>
<li><a href="../lab06sz.html">6. hét, szombat: gyakorlófeladatok</a>
<li><a href="../lab08.html">8. hét: mutatók, sztringek</a>
<li><a href="../lab09.html">9. hét: dinamikus tömbök</a>
<li><a href="../lab10.html">10. hét: rekurzió és állapotgépek</a>
<li><a href="../lab11.html">11. hét: láncolt listák</a>
<li><a href="../lab12.html">12. hét: duplán láncolt listák</a>
<li><a href="../lab13.html">13. hét: bináris fák</a>
<li><a href="../lab14.html">14. hét: labirintus játék</a>
</ul>

<li class="al "><a href="index.html@v=17.html#" onclick="menu_click(this)">Példatár</a>
<ul>
<li><a href="../f01.html">1. hét: egyszerű programok</a>
<li><a href="../f02.html">2. hét: vezérlési szerkezetek</a>
<li><a href="../f03.html">3. hét: logika, sorozatok, tömbök</a>
<li><a href="../f04.html">4. hét: számábrázolás, bitek, függvények</a>
<li><a href="../f05.html">5. hét: operátorok, struktúrák</a>
<li><a href="../f06.html">6. hét: pointerek, sztringek, állapotgépek</a>
<li><a href="../f07.html">7. hét: rendezések, rekurzió</a>
<li><a href="../f08.html">8. hét: dinamikus memóriakezelés</a>
<li><a href="../f09.html">9. hét: láncolt listák</a>
<li><a href="../f11.html">11. hét: parancssor, fájlkezelés, modulok</a>
<li><a href="../f12.html">12. hét: bináris fák, többszörös indirekció</a>
<li><a href="../f13.html">13. hét: generikus algoritmusok</a>
</ul>

</ul>

<li class="al "><a href="index.html@v=17.html#" onclick="menu_click(this)">Segédlet</a>
<ul>
<li><a href="../jegyzet.html">Jegyzet és puska</a>
<li><a href="../fejlesztokornyezet.html">Fejlesztőkörnyezetek</a>
<li><a href="../stilus.html">Kódolási stílus</a>
<li><a href="../tanacsok.html">Tanácsok a tanuláshoz</a>
<li><a href="../debugmalloc.html">Debugmalloc</a>
<li><a href="../mintanhf.html">NHF minta</a>
</ul>

<li class="al "><a href="index.html@v=17.html#" onclick="menu_click(this)">Extrák</a>
<ul>
<li class="al "><a href="index.html@v=17.html#" onclick="menu_click(this)">Szorgalmik, versenyek</a>
<ul>
<li><a href="../nhfszepsegverseny2014.html">NHF szépségverseny 2014</a>
<li><a href="../nhfszepsegverseny2013.html">NHF szépségverseny 2013</a>
<li><a href="../nhfszepsegverseny2012.html">NHF szépségverseny 2012</a>
<li><a href="../orak.html">SVG óra galéria</a>
<li><a href="../angrybirds.html">SVG Angry Birds</a>
</ul>

<li class="al "><a href="index.html@v=17.html#" onclick="menu_click(this)">Elmélet</a>
<ul>
<li><a href="../turing.html">Mit tud a számítógép?</a>
<li><a href="../bf.html">BF</a>
<li><a href="../bitturmix.html">Bitturmix</a>
<li><a href="../labirintus.html">Labirintusok</a>
<li><a href="../tripla.html">Tripla indirekció</a>
</ul>

<li class="al "><a href="index.html@v=17.html#" onclick="menu_click(this)">Gyakorlat</a>
<ul>
<li><a href="../karakterkodolas.html">Karakterkódolások</a>
<li><a href="../strlcpy.html">Kulturált sztringmásoló</a>
<li><a href="../internet.html">Internet</a>
</ul>

<li class="al "><a href="index.html@v=17.html#" onclick="menu_click(this)">Grafika</a>
<ul>
<li><a href="../sdl.html">SDL grafika</a>
<li><a href="../sdl_telepito.html">SDL telepítés</a>
<li><a href="../fa.html">Fák rajzolása</a>
<li><a href="../lathatatlan.html">Láthatatlan zongorista</a>
</ul>

<li class="al "><a href="index.html@v=17.html#" onclick="menu_click(this)">Nyelvészet</a>
<ul>
<li><a href="../mondatelemzo.html">Mondatelemző</a>
<li><a href="../kifejezesek.html">Kifejezések</a>
<li><a href="../derivalas.html">Deriválás</a>
<li><a href="../ast_epit.html">AST: szintaxisfák</a>
<li><a href="../ast_epit_copa.html">AST: értékadás I.</a>
<li><a href="../ast_epit_parameteres.html">AST: értékadás II.</a>
</ul>

<li><a href="../advent.html">Adventi naptár</a>
</ul>

</ul>
</div>
</div>
</nav>

<main role="main">
<div id="doksi" class="shaper">
<section id="0">
<div class="slide" id="slide_0">
<div class="float" style="margin-top: 0.25em; margin-bottom: 0;"><a href="../advent.html">&larr; vissza</a></div>
<h1 class="eloadascim">Adventi naptár</h1>
<h2>Fizikai motor – World of Goo, „A ragacsok világa”</h2>

<img class="float" src="advent17-wog.png">

<p>
Csábító lenne a mai alkalommal a tegnapi, biliárdos programot
matematikailag továbbfejleszteni: az Euler integrátort lecserélni Runge–Kutta integrátorra…
Azonban nem ez lesz a mai naptárbejegyzésben. Helyette
World of Goo-vá alakítjuk át a programot.



<nav><div id="tartalom">
<h3>Tartalom</h3>
<ol>
<li><a href="index.html@v=17.html#1">A fizikai motor</a>
<li><a href="index.html@v=17.html#2">Rugók létrejötte és megszűnése</a>
<li><a href="index.html@v=17.html#3">Az egér kezelése</a>
<li><a href="index.html@v=17.html#4">A program</a>
</ol>
</div>
</nav>
</div>
</section>
<section id="1">
<div class="slide" id="slide_1">
<div class="slideheader">
<h2><span class="oldalszam">1</span>A fizikai motor</h2>
</div>

<p>
Mit is csinált a tegnapi program? Golyók mozogtak benne a képernyőn, közben
egymással és a fallal ütköztek. Minden időszeletben kiszámolta a program a golyókra
ható erőket (amelyek ütközések által keletkeztek). Aztán azok alapján a gyorsulásokat, azokból
pedig a sebességeket, amikből végül a helyzeteket:

<pre class="brush: c "  >
Golyo g;

g.x += g.vx*delta_t;
g.y += g.vy*delta_t;

g.vx += (g.fx/m)*delta_t;  /* ax*delta_t */
g.vy += (g.fy/m)*delta_t;  /* ay*delta_t */</pre>

<img src="advent17-utkozes.svg" style="width: 14em;" class="float">

<p>A golyókra a következő erők hatottak:
<ul>
   <li>Ha a golyó falnak ütközött, akkor a fal eltaszította magától.
   <li>Ha két golyó egymásnak ütközott, akkor azok is taszították egymást.
   <li>Ha egy golyó gurult, akkor súrlódási erő hatott rá.
</ul>

<p>
Leglényegesebb két golyó ütközése volt. Ezt egy rugóval modelleztük. Ha a két
golyó középpontjának távolsága kisebb volt, mint a sugaraik összege, akkor
összenyomódtak – és ilyenkor egy közéjük képzelt erős rugó taszította el őket egymástól:

<pre class="brush: c "  >
/* golyók távolsága */
dx=x1-x2;
dy=y1-y2;
tav=sqrt(dx*dx+dy*dy);

/* rugóerő */
if (tav&lt;2*golyo_r) {
   l=2*golyo_r-tav;
   f=golyo_d*l;
   fx+=dx/tav*f; /* egységvektor*f */
   fy+=dy/tav*f;
}</pre>



</div>
</section>
<section id="2">
<div class="slide" id="slide_2">
<div class="slideheader">
<h2><span class="oldalszam">2</span>Rugók létrejötte és megszűnése</h2>
</div>

<p>
Ezt a programot nagyon könnyen át tudjuk úgy alakítani, hogy a World of Goo-hoz
hasonló játékot kapjunk. Először is, a zöld hátteret le kell cserélni feketére. :)
Na jó, szóval a lényeg az, hogy két új erőt kell szimulálni:

<ul>
   <li>a gravitációt,
   <li>rugókat is kell létrehozni a golyók között, amelyeknek az erejét figyelembe kell
      venni.
</ul>

<p>A letölthető program működése a következő:

<img class="float" src="advent17-wog.png">

<ul>
   <li>A tegnap bemutatott fizikai motorral szimulálja a golyók mozgását. A golyók
      ütközéskor taszítják egymást, és hat rájuk a gravitáció is.
   <li>Az egérgombbal meg lehet fogni egy golyót (kék), aztán „fog és vidd” (drag and drop)
      módszerrel áttenni máshova.
      <ul>
         <li>Ha másik golyókhoz közel tesszük le, akkor a kellően közeli golyók
            és a letett golyók közé egy rugót hoz létre a program.
         <li>Amikor megfogunk egy golyót, akkor viszont kitöröljük azokat
            a rugókat, amelyekkel eddig más golyókhoz volt kötve.
      </ul>
   <li>A rugók hossza adott: erőt fejtenek ki akkor is, ha széthúzzuk, és akkor is,
      ha összenyomjuk őket. Vagyis ezek sokkal inkább úgy működnek, mint az igazi
      rugók, szemben a golyók ütközésekor közéjük képzelt fiktív rugókkal:
<pre class="brush: c "  >
double f=rugo_d*(tav-rugohossz),  /* erő */
       fx=dx/tav*f,               /* x és y komponensek */
       fy=dy/tav*f;
golyo[g1].fx-=fx;
golyo[g1].fy-=fy;
golyo[g2].fx+=fx;
golyo[g2].fy+=fy;</pre>
   <li>Ha egy rugó túl hosszúra nyúlik (a természetes hosszának duplájára), akkor elszakad.
   <li>Van a pályán fix golyó is (piros), amelynek nem változik a helyzete. Erre fel lehet
      lógatni az építményünket.
</ul>

<p>A golyókat a program egy tömbben tárolja (<code>golyo[]</code>), mivel azok száma
nem változik a futás során. Változik viszont a rugóknak a száma, ezért ahhoz egy láncolt
lista kell. Mivel gyakran kell beszúrni és törölni is a listába, egyszerűbb egy strázsás
listát választani. (Nagy úr a lustaság.) A rugókhoz elég csak két
tömbindexet eltárolni, hogy melyik két golyót kötik össze:

<pre class="brush: c "  >
typedef struct Rugo {
   int g1, g2;                   /* ket tombinex - mely golyokat koti ossze */
   struct Rugo *prev, *next;     /* duplan lancolt listahoz */
} Rugo;</pre>



</div>
</section>
<section id="3">
<div class="slide" id="slide_3">
<div class="slideheader">
<h2><span class="oldalszam">3</span>Az egér kezelése</h2>
</div>

<p>A játék futását alapvetően az idő vezérli, de a szimulációba be tudunk avatkozni
az egérrel. Az egérgombnak nem az állapotát, hanem annak változását kell érzékelnünk:
 
<ul>
   <li>Ha előzőleg nem volt lenyomva a gomb, de az aktuális pillanatban igen, akkor
      egy kattintást érzékeltünk. Ilyenkor kell megkeresni az egérmutatóhoz közeli
      golyót, mert azt szeretné a játékos megfogni (drag).
   <li>Ha előzőleg le volt nyomva, de most nincs, akkor ez egy elengedés. Ilyenkor szeretné
      a játékos letenni a golyót (drop).
</ul>

<img src="advent17-allapot.svg" style="width: 18em;" class="kozep">

<p>Figyelni kell egyébként azért itt nem csak az állapotváltozásra, hanem az állapotra magára is.
Ugyanis ha kattintáskor a játékos megfogott egy golyót, akkor az egérgomb nyomvatartásakor
húzza azt. Ilyenkor a golyó koordinátáját folyamatosan módosítani kell az egérmutató koordinátája alapján.

<p>Ezeket a műveleteket a programban az eseménykezelő ciklus vezérli.
Ez látja a golyók tömbjét (<code>golyo</code>, mérete <code>golyok</code>), a rugók
listáját, és a megfogott golyó indexét: <code>megfogott</code>.
Az utóbbi változhat, például kattintáskor a „nincs a kezünkben semmi” jelentésű
<code>-1</code>-es értéket leváltja egy <code>golyo[]</code> tömbbeli index:

<pre class="brush: c "  >
case SDL_MOUSEBUTTONDOWN:   /* egér kattintás */
    mouse_x = ev.button.x;
    mouse_y = ev.button.y;
    for (i=0; i&lt;golyok &amp;&amp; megfogott==-1; ++i) {
        double dx=golyo[i].x-mouse_x;
        double dy=golyo[i].y-mouse_y;
        if (dx*dx+dy*dy &lt;= golyoelkap*golyoelkap) { /* ha elég közel volt az egérhez */
            megfogott=i;
            if (!golyo[i].fix) {               /* ha nem fix, kiszakitjuk */
                Rugo *iter=rugo.eleje-&gt;next;
                while (iter!=rugo.vege) {
                    Rugo *iternext=iter-&gt;next;
                    if (iter-&gt;g1==i || iter-&gt;g2==i)
                        rugolista_torol(iter);
                    iter=iternext;
                }
            }
        }
    }
    break;</pre>

<p>Elengedéskor pedig az új rugók létrehozásán túl végül visszakerül a változóba
a <code>-1</code>:

<pre class="brush: c "  >
case SDL_MOUSEBUTTONUP:     /* egér elengedés */
    mouse_x = ev.button.x;
    mouse_y = ev.button.y;

    for (i=0; i&lt;golyok; ++i) {
        if (i==megfogott) continue;
        double dx=golyo[i].x-golyo[megfogott].x;
        double dy=golyo[i].y-golyo[megfogott].y;
        if (dx*dx+dy*dy &lt;= rugoelkap*rugoelkap)
            rugolista_hozzaad(&amp;rugo, i, megfogott);
    }
    megfogott=-1;
    break;</pre>

<p>Az egérgomb nyomvatartásakor a golyó cipelése egyszerű, egyszerűen
kihagyjuk a mozgatásból:
<pre class="brush: c "  >
for (i=0; i&lt;golyok; i++) {
    if (golyo[i].fix || i==megfogott) continue;
    golyo[i].x+=golyo[i].vx * delta_t;
    golyo[i].y+=golyo[i].vy * delta_t;
    golyo[i].vx+=golyo[i].fx/golyo_m * delta_t;
    golyo[i].vy+=golyo[i].fy/golyo_m * delta_t;
}</pre>

<p>Végülis ennyi az egész. Minden más szinte ugyanúgy van, mint a tegnapi 
programban. Még a súrlódás is. Valamilyen fékező erőnek kell lennie, amitől 
a rezgések csillapodnak. Bár elvileg súrlódás a levegőben nincs, csak más 
törvényszerűség szerint létrejövő közegellenállás, de a program az előbbivel 
számol. 

</div>
</section>
<section id="4">
<div class="slide" id="slide_4">
<div class="slideheader">
<h2><span class="oldalszam">4</span>A program</h2>
</div>

<p>A program letölthető innen: <a href="advent17-wog.c">advent17-wog.c</a>.
Kicsit szépítgetni kellett, hogy beleférjen 300 sorba, de éppen belefér.
</div>
</section>
</div>
</main>

<nav role="navigation">
<a href="index.html@v=17.html#menu" id="scrolltotop"></a>
</nav>

<footer role="contentinfo">
<div id="footer" class="shaper">
<a href="../index.html"><img src="../modulz/logo.png" id="footerlogo" alt="Logo"></a>
<div>InfoC – Programozás alapjai I.</div>
<div class="csakkepernyon"><a href="../index.html">főoldal</a> · <a href="../elerhetoseg.html">elérhetőség</a> · <a href="https://www.facebook.com/infoceetbmehu">facebook</a></div>
<div class="csaknyomtatasban">Kérjük, az oldalak kinyomtatása előtt gondolj a környezetre.</div>
BME EET, 2009-2014.</div>
</footer>

</div>
</body>

</html>
